name: Production (Release & Sync)

on:
  push:
    branches:
      - production

jobs:
  # ----------------------------------------------------------------------
  # JOB 1: RUN TESTS
  # We must ensure code is stable before we version it.
  # ----------------------------------------------------------------------
  laravel-tests:
    name: Run Laravel Tests
    # Skip if this is the automated bump commit to prevent infinite loops
    if: ${{ !startsWith(github.event.head_commit.message, 'bump:') }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.3"
          extensions: mbstring, xml, dom, curl, pdo, pdo_mysql, bcmath, sqlite, pdo_sqlite
          ini-values: post_max_size=256M, upload_max_filesize=256M
          coverage: pcov

      - name: Get Composer Cache Directory
        id: composer-cache
        run: echo "dir=$(composer config cache-files-dir)" >> $GITHUB_OUTPUT

      - name: Cache Composer dependencies
        uses: actions/cache@v4
        with:
          path: ${{ steps.composer-cache.outputs.dir }}
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-composer-

      - name: Install Composer Dependencies
        run: composer install --no-progress --prefer-dist --optimize-autoloader --no-interaction

      - name: Prepare Laravel Environment
        run: |
          cp .env.example .env
          php artisan key:generate
          echo "DB_CONNECTION=sqlite" >> .env
          echo "DB_DATABASE=:memory:" >> .env

      - name: Run Database Migrations
        run: php artisan migrate --force

      - name: Execute tests (PHPUnit)
        run: php artisan test --coverage --min=80.3

  # ----------------------------------------------------------------------
  # JOB 2: BUMP VERSION & RELEASE
  # Runs only if tests pass.
  # ----------------------------------------------------------------------
  bump-and-release:
    name: Bump Version & Release
    needs: laravel-tests
    runs-on: ubuntu-latest
    if: ${{ !startsWith(github.event.head_commit.message, 'bump:') }}
    permissions:
      contents: write # Required to create releases and tags

    steps:
      # 1. Checkout with PAT (Required to push back to protected branch)
      - name: Check out
        uses: actions/checkout@v3
        with:
          token: "${{ secrets.PERSONAL_ACCESS_TOKEN }}"
          fetch-depth: 0

      # 2. Commitizen Action
      - name: Create bump and changelog
        id: cz
        uses: commitizen-tools/commitizen-action@master
        with:
          github_token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
          branch: production
          push: true
          changelog_increment_filename: body.md

      # 3. GitHub Release
      - name: Release
        uses: softprops/action-gh-release@v1
        with:
          body_path: "body.md"
          tag_name: ${{ steps.cz.outputs.version }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 4. Trigger Ploi Deployment
      # - name: Trigger Ploi
      #   run: curl -X POST ${{ secrets.PLOI_DEPLOY_WEBHOOK_PROD }}

      # 5. Sync Back to Main
      - name: Sync Production back to Main
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          git fetch origin main
          git checkout main
          git merge production
          git push origin main
